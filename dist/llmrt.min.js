!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).LLMRT={})}(this,function(e){"use strict";class t{constructor(){this.modules=new Map,this.renderModules=new Map,this.actionHandlers=new Map,this.triggerEvents=new Set}static getInstance(){return t.instance||(t.instance=new t),t.instance}registerModule(e){this.modules.set(e.name,e),e.nodeTypes.forEach(e=>{}),e.actions.forEach(e=>{}),e.triggers.forEach(e=>{this.triggerEvents.add(e)})}registerRenderModule(e){this.renderModules.set(e.name,e)}registerActionHandler(e,t){this.actionHandlers.set(e,t)}getModule(e){return this.modules.get(e)}getRenderModule(e){return this.renderModules.get(e)}getRenderModulesForNodeType(e){return Array.from(this.renderModules.values()).filter(t=>t.nodeTypes.includes(e))}getActionHandler(e){return this.actionHandlers.get(e)}isRegisteredModule(e){return this.modules.has(e)}getRegisteredModules(){return Array.from(this.modules.values())}getRenderModules(){return Array.from(this.renderModules.values())}getEstimatedSize(){return Array.from(this.modules.values()).reduce((e,t)=>e+t.size,0)}supportsNodeType(e){return!!["Group","Sprite","Text","Button","Camera2D","Particles2D","PostChain"].includes(e)||Array.from(this.modules.values()).some(t=>t.nodeTypes.includes(e))}supportsTriggerEvent(e){return!!["on.start","on.tick","on.key","on.pointer","on.timer"].includes(e)||this.triggerEvents.has(e)}}class s{constructor(){this.keyMappings=new Map,this.pointerMappings=new Map,this.actionStates=new Map,this.keyStates=new Map,this.canvas=null,this.frameCount=0,this.isInitialized=!1,this.pointerState={position:{x:0,y:0},worldPosition:{x:0,y:0},buttons:new Map},this.boundKeyDown=this.handleKeyDown.bind(this),this.boundKeyUp=this.handleKeyUp.bind(this),this.boundPointerDown=this.handlePointerDown.bind(this),this.boundPointerUp=this.handlePointerUp.bind(this),this.boundPointerMove=this.handlePointerMove.bind(this),this.boundContextMenu=this.handleContextMenu.bind(this)}initialize(e){this.isInitialized&&this.cleanup(),this.canvas=e,this.isInitialized=!0,document.addEventListener("keydown",this.boundKeyDown),document.addEventListener("keyup",this.boundKeyUp),e.addEventListener("pointerdown",this.boundPointerDown),e.addEventListener("pointerup",this.boundPointerUp),e.addEventListener("pointermove",this.boundPointerMove),e.addEventListener("contextmenu",this.boundContextMenu),e.tabIndex=0,e.style.outline="none"}cleanup(){this.isInitialized&&(document.removeEventListener("keydown",this.boundKeyDown),document.removeEventListener("keyup",this.boundKeyUp),this.canvas&&(this.canvas.removeEventListener("pointerdown",this.boundPointerDown),this.canvas.removeEventListener("pointerup",this.boundPointerUp),this.canvas.removeEventListener("pointermove",this.boundPointerMove),this.canvas.removeEventListener("contextmenu",this.boundContextMenu)),this.canvas=null,this.isInitialized=!1)}mapKey(e,t){const s=this.sanitizeKey(e),i=this.sanitizeAction(t);s&&i&&this.keyMappings.set(s,i)}mapPointer(e,t){if(e<0||e>4)return;const s=this.sanitizeAction(t);s&&this.pointerMappings.set(e,s)}isActionPressed(e){const t=this.actionStates.get(e);return!!t&&t.pressed}isActionJustPressed(e){const t=this.actionStates.get(e);return!!t&&t.justPressed}isActionJustReleased(e){const t=this.actionStates.get(e);return!!t&&t.justReleased}getPointerPosition(){return{...this.pointerState.position}}getPointerWorldPosition(e){return{...this.pointerState.position}}update(){this.frameCount++,this.updateActionStates(),this.clearFrameFlags()}handleKeyDown(e){const t=this.normalizeKey(e.code);if(!t)return;this.keyMappings.get(t)&&e.preventDefault(),this.updateKeyState(t,!0)}handleKeyUp(e){const t=this.normalizeKey(e.code);t&&this.updateKeyState(t,!1)}handlePointerDown(e){this.canvas&&(e.preventDefault(),this.canvas.focus(),this.updatePointerPosition(e),this.updatePointerButtonState(e.button,!0))}handlePointerUp(e){e.preventDefault(),this.updatePointerPosition(e),this.updatePointerButtonState(e.button,!1)}handlePointerMove(e){this.updatePointerPosition(e)}handleContextMenu(e){e.preventDefault()}updatePointerPosition(e){if(!this.canvas)return;const t=this.canvas.getBoundingClientRect();this.pointerState.position={x:e.clientX-t.left,y:e.clientY-t.top}}updateKeyState(e,t){let s=this.keyStates.get(e);s||(s={pressed:!1,justPressed:!1,justReleased:!1,framePressed:-1,frameReleased:-1},this.keyStates.set(e,s)),t&&!s.pressed?(s.pressed=!0,s.justPressed=!0,s.framePressed=this.frameCount):!t&&s.pressed&&(s.pressed=!1,s.justReleased=!0,s.frameReleased=this.frameCount)}updatePointerButtonState(e,t){let s=this.pointerState.buttons.get(e);s||(s={pressed:!1,justPressed:!1,justReleased:!1,framePressed:-1,frameReleased:-1},this.pointerState.buttons.set(e,s)),t&&!s.pressed?(s.pressed=!0,s.justPressed=!0,s.framePressed=this.frameCount):!t&&s.pressed&&(s.pressed=!1,s.justReleased=!0,s.frameReleased=this.frameCount)}updateActionStates(){for(const[e,t]of this.keyMappings){const s=this.keyStates.get(e);s&&this.updateActionState(t,s)}for(const[e,t]of this.pointerMappings){const s=this.pointerState.buttons.get(e);s&&this.updateActionState(t,s)}}updateActionState(e,t){let s=this.actionStates.get(e);if(s||(s={pressed:!1,justPressed:!1,justReleased:!1,framePressed:-1,frameReleased:-1},this.actionStates.set(e,s)),t.pressed&&(s.pressed||(s.pressed=!0,s.justPressed=!0,s.framePressed=this.frameCount)),!t.pressed&&s.pressed){let t=!1;for(const[s,i]of this.keyMappings)if(i===e){const e=this.keyStates.get(s);if(e&&e.pressed){t=!0;break}}if(!t)for(const[s,i]of this.pointerMappings)if(i===e){const e=this.pointerState.buttons.get(s);if(e&&e.pressed){t=!0;break}}t||(s.pressed=!1,s.justReleased=!0,s.frameReleased=this.frameCount)}}clearFrameFlags(){for(const e of this.keyStates.values())e.justPressed&&e.framePressed<this.frameCount&&(e.justPressed=!1),e.justReleased&&e.frameReleased<this.frameCount&&(e.justReleased=!1);for(const e of this.pointerState.buttons.values())e.justPressed&&e.framePressed<this.frameCount&&(e.justPressed=!1),e.justReleased&&e.frameReleased<this.frameCount&&(e.justReleased=!1);for(const e of this.actionStates.values())e.justPressed&&e.framePressed<this.frameCount&&(e.justPressed=!1),e.justReleased&&e.frameReleased<this.frameCount&&(e.justReleased=!1)}normalizeKey(e){const t=e.replace(/^(Key|Digit|Numpad|Arrow)/,"").toLowerCase();return{space:"space",enter:"enter",escape:"escape",tab:"tab",backspace:"backspace",delete:"delete",home:"home",end:"end",pageup:"pageup",pagedown:"pagedown",up:"up",down:"down",left:"left",right:"right"}[t]||t}sanitizeKey(e){const t=e.toLowerCase().trim();return/^[a-z0-9]$|^(space|enter|escape|tab|backspace|delete|home|end|pageup|pagedown|up|down|left|right|shift|ctrl|alt|meta)$/i.test(t)?t:null}sanitizeAction(e){const t=e.trim();return/^[a-zA-Z0-9_-]+$/.test(t)&&t.length<=50?t:null}}class i{constructor(){this.assets=new Map,this.currentMusic=null,this.masterVolume=1,this.unlocked=!1,this.unlockPromise=null,this.handleUserInteraction=this.handleUserInteraction.bind(this),this.setupAutoUnlock()}playSfx(e,t=1){const s=this.assets.get(e);if(!s||"sfx"!==s.type)return;const i=s.audio.cloneNode();if(i.volume=Math.max(0,Math.min(1,t*this.masterVolume)),i.addEventListener("ended",()=>{i.remove()}),this.unlocked){const e=i.play();e&&"function"==typeof e.catch&&e.catch(e=>{})}else this.unlock().then(()=>{const e=i.play();e&&"function"==typeof e.catch&&e.catch(e=>{})})}playMusic(e,t=!0,s=1){const i=this.assets.get(e);if(i&&"music"===i.type)if(this.stopMusic(),this.currentMusic=i.audio.cloneNode(),this.currentMusic.loop=t,this.currentMusic.volume=Math.max(0,Math.min(1,s*this.masterVolume)),this.unlocked){const e=this.currentMusic.play();e&&"function"==typeof e.catch&&e.catch(e=>{})}else this.unlock().then(()=>{if(this.currentMusic){const e=this.currentMusic.play();e&&"function"==typeof e.catch&&e.catch(e=>{})}})}stopMusic(){this.currentMusic&&(this.currentMusic.pause(),this.currentMusic.currentTime=0,this.currentMusic=null)}setMasterVolume(e){this.masterVolume=Math.max(0,Math.min(1,e)),this.currentMusic&&(this.currentMusic.volume=this.currentMusic.volume*this.masterVolume)}async loadAssets(e){const t=e.map(e=>this.loadAsset(e));await Promise.all(t)}cleanup(){this.stopMusic(),this.assets.clear(),this.removeAutoUnlock()}isUnlocked(){return this.unlocked}async unlock(){if(!this.unlocked)return this.unlockPromise||(this.unlockPromise=this.performUnlock()),this.unlockPromise}async loadAsset(e){return new Promise((t,s)=>{const i=new Audio;i.addEventListener("canplaythrough",()=>{this.assets.set(e.id,{id:e.id,audio:i,type:e.type}),t()}),i.addEventListener("error",e=>{s(e)}),i.preload="auto",i.src=e.url})}setupAutoUnlock(){["click","touchstart","keydown"].forEach(e=>{document.addEventListener(e,this.handleUserInteraction,{once:!0,passive:!0})})}removeAutoUnlock(){["click","touchstart","keydown"].forEach(e=>{document.removeEventListener(e,this.handleUserInteraction)})}handleUserInteraction(){this.unlock()}async performUnlock(){try{const e=new Audio;e.src="data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIG2m98OScTgwOUarm7blmHgU7k9n1unEiBC13yO/eizEIHWq+8+OWT",e.volume=0,await e.play(),this.unlocked=!0,this.removeAutoUnlock()}catch(e){this.unlocked=!0}finally{this.unlockPromise=null}}}class a{constructor(){}validate(e){const t=[],s=[];try{return this.validateStructure(e,"",t),0===t.length&&this.validateSemantics(e,s),{valid:0===t.length,errors:t,warnings:s}}catch(e){return t.push({path:"",message:`Validation failed: ${e instanceof Error?e.message:"Unknown error"}`,code:"VALIDATION_ERROR"}),{valid:!1,errors:t,warnings:s}}}validateStructure(e,t,s){if(""===t){if("object"!=typeof e||null===e)return void s.push({path:"",message:"Cartridge must be a JSON object",suggestion:"Ensure your cartridge is a valid JSON object with required properties",code:"INVALID_ROOT_TYPE"});const t=["version","metadata","theme","scenes","assets"];for(const i of t)i in e||s.push({path:i,message:`Missing required property: ${i}`,suggestion:`Add the "${i}" property to your cartridge`,code:"MISSING_REQUIRED_PROPERTY"});const i=[...t,"variables"];for(const t in e)i.includes(t)||s.push({path:t,message:`Unknown property: ${t}`,suggestion:`Remove "${t}" or check for typos. Allowed properties: ${i.join(", ")}`,code:"UNKNOWN_PROPERTY"});return void 0!==e.version&&this.validateStructure(e.version,"version",s),void 0!==e.metadata&&this.validateStructure(e.metadata,"metadata",s),void 0!==e.theme&&this.validateStructure(e.theme,"theme",s),void 0!==e.scenes&&this.validateStructure(e.scenes,"scenes",s),void 0!==e.assets&&this.validateStructure(e.assets,"assets",s),void(void 0!==e.variables&&this.validateStructure(e.variables,"variables",s))}"version"!==t?"metadata"!==t?"theme"!==t?"scenes"!==t?"assets"!==t?"variables"!==t||this.validateVariables(e,s):this.validateAssets(e,s):this.validateScenes(e,s):this.validateTheme(e,s):this.validateMetadata(e,s):"1.0"!==e&&s.push({path:"version",message:`Invalid version: ${e}`,suggestion:'Use version "1.0"',code:"INVALID_VERSION"})}validateMetadata(e,t){if("object"!=typeof e||null===e)return void t.push({path:"metadata",message:"Metadata must be an object",suggestion:"Provide metadata with title, author, and description",code:"INVALID_METADATA_TYPE"});const s=["title","author","description"];for(const i of s)i in e?"string"==typeof e[i]&&0!==e[i].length||t.push({path:`metadata.${i}`,message:`Metadata ${i} must be a non-empty string`,suggestion:`Provide a valid ${i} string`,code:"INVALID_METADATA_VALUE"}):t.push({path:`metadata.${i}`,message:`Missing required metadata field: ${i}`,suggestion:`Add "${i}" to your metadata`,code:"MISSING_METADATA_FIELD"})}validateTheme(e,t){if("object"==typeof e&&null!==e){if(e.colors&&"object"==typeof e.colors){const s=["primary","secondary","background","text","accent"];for(const i of s)i in e.colors?this.isValidColor(e.colors[i])||t.push({path:`theme.colors.${i}`,message:`Invalid color format: ${e.colors[i]}`,suggestion:"Use hex color format like #FF0000 or #F00",code:"INVALID_COLOR_FORMAT"}):t.push({path:`theme.colors.${i}`,message:`Missing required color: ${i}`,suggestion:`Add "${i}" color to your theme`,code:"MISSING_THEME_COLOR"})}else t.push({path:"theme.colors",message:"Theme colors must be an object",suggestion:"Provide colors object with primary, secondary, background, text, and accent",code:"INVALID_THEME_COLORS"});e.font&&"object"==typeof e.font||t.push({path:"theme.font",message:"Theme font must be an object",suggestion:"Provide font object with family and sizes",code:"INVALID_THEME_FONT"}),["spacing","radii"].forEach(s=>{e[s]&&"object"==typeof e[s]||t.push({path:`theme.${s}`,message:`Theme ${s} must be an object`,suggestion:`Provide ${s} object with numeric values`,code:"INVALID_THEME_PROPERTY"})})}else t.push({path:"theme",message:"Theme must be an object",suggestion:"Provide theme with colors, font, spacing, and radii",code:"INVALID_THEME_TYPE"})}validateScenes(e,t){if(!Array.isArray(e))return void t.push({path:"scenes",message:"Scenes must be an array",suggestion:"Provide an array of scene objects",code:"INVALID_SCENES_TYPE"});if(0===e.length)return void t.push({path:"scenes",message:"At least one scene is required",suggestion:"Add at least one scene to your cartridge",code:"NO_SCENES"});const s=new Set;e.forEach((e,i)=>{"object"==typeof e&&null!==e?(e.id&&"string"==typeof e.id?(s.has(e.id)&&t.push({path:`scenes[${i}].id`,message:`Duplicate scene id: ${e.id}`,suggestion:"Use unique scene identifiers",code:"DUPLICATE_SCENE_ID"}),s.add(e.id),/^[a-zA-Z][a-zA-Z0-9_-]*$/.test(e.id)||t.push({path:`scenes[${i}].id`,message:`Invalid scene id format: ${e.id}`,suggestion:"Scene ids must start with a letter and contain only letters, numbers, underscores, and hyphens",code:"INVALID_ID_FORMAT"})):t.push({path:`scenes[${i}].id`,message:"Scene id must be a non-empty string",suggestion:"Provide a unique scene identifier",code:"INVALID_SCENE_ID"}),e.root?this.validateNode(e.root,`scenes[${i}].root`,t):t.push({path:`scenes[${i}].root`,message:"Scene must have a root node",suggestion:"Provide a root node for the scene",code:"MISSING_SCENE_ROOT"})):t.push({path:`scenes[${i}]`,message:"Scene must be an object",suggestion:"Provide scene object with id and root node",code:"INVALID_SCENE_TYPE"})})}validateNode(e,t,s){if("object"!=typeof e||null===e)return void s.push({path:t,message:"Node must be an object",suggestion:"Provide node object with required properties",code:"INVALID_NODE_TYPE"});const i=["id","type","transform","visible","children","actions","triggers"];for(const a of i)a in e||s.push({path:`${t}.${a}`,message:`Missing required node property: ${a}`,suggestion:`Add "${a}" to your node`,code:"MISSING_NODE_PROPERTY"});!e.id||"string"==typeof e.id&&/^[a-zA-Z][a-zA-Z0-9_-]*$/.test(e.id)||s.push({path:`${t}.id`,message:`Invalid node id format: ${e.id}`,suggestion:"Node ids must start with a letter and contain only letters, numbers, underscores, and hyphens",code:"INVALID_NODE_ID"});const a=["Group","Sprite","Text","Button","Camera2D","Particles2D","PostChain","Mode7Plane","RaycastMap","TilemapIso"];e.type&&!a.includes(e.type)&&s.push({path:`${t}.type`,message:`Invalid node type: ${e.type}`,suggestion:`Use one of: ${a.join(", ")}`,code:"INVALID_NODE_TYPE_VALUE"}),e.transform&&this.validateTransform(e.transform,`${t}.transform`,s),e.children&&Array.isArray(e.children)&&e.children.forEach((e,i)=>{this.validateNode(e,`${t}.children[${i}]`,s)}),e.actions&&Array.isArray(e.actions)&&e.actions.forEach((e,i)=>{this.validateAction(e,`${t}.actions[${i}]`,s)}),e.triggers&&Array.isArray(e.triggers)&&e.triggers.forEach((e,i)=>{this.validateTrigger(e,`${t}.triggers[${i}]`,s)})}validateTransform(e,t,s){if("object"!=typeof e||null===e)return void s.push({path:t,message:"Transform must be an object",suggestion:"Provide transform with position, scale, rotation, skew, and alpha",code:"INVALID_TRANSFORM_TYPE"});const i=["position","scale","rotation","skew","alpha"];for(const a of i)a in e||s.push({path:`${t}.${a}`,message:`Missing required transform property: ${a}`,suggestion:`Add "${a}" to your transform`,code:"MISSING_TRANSFORM_PROPERTY"});["position","scale","skew"].forEach(i=>{e[i]&&this.validateVector2(e[i],`${t}.${i}`,s)}),void 0!==e.rotation&&"number"!=typeof e.rotation&&s.push({path:`${t}.rotation`,message:"Transform rotation must be a number",suggestion:"Provide rotation as a numeric value in radians",code:"INVALID_ROTATION_TYPE"}),void 0!==e.alpha&&("number"!=typeof e.alpha||e.alpha<0||e.alpha>1)&&s.push({path:`${t}.alpha`,message:"Transform alpha must be a number between 0 and 1",suggestion:"Provide alpha as a numeric value between 0 (transparent) and 1 (opaque)",code:"INVALID_ALPHA_VALUE"})}validateVector2(e,t,s){if(Array.isArray(e))return 2!==e.length?void s.push({path:t,message:"Vector2 array must have exactly 2 elements",suggestion:"Provide vector as [x, y] with two numeric values",code:"INVALID_VECTOR2_ARRAY_LENGTH"}):void e.forEach((e,i)=>{"number"!=typeof e&&s.push({path:`${t}[${i}]`,message:"Vector2 array element must be a number",suggestion:`Provide numeric value at index ${i}`,code:"INVALID_VECTOR2_ARRAY_VALUE"})});"object"==typeof e&&null!==e?["x","y"].forEach(i=>{i in e?"number"!=typeof e[i]&&s.push({path:`${t}.${i}`,message:`Vector ${i} must be a number`,suggestion:`Provide ${i} as a numeric value`,code:"INVALID_VECTOR_VALUE"}):s.push({path:`${t}.${i}`,message:`Missing required vector property: ${i}`,suggestion:`Add "${i}" numeric value to your vector`,code:"MISSING_VECTOR_PROPERTY"})}):s.push({path:t,message:"Vector2 must be an array [x, y] or object {x, y}",suggestion:"Provide vector as [x, y] array or {x, y} object with numeric values",code:"INVALID_VECTOR2_TYPE"})}validateAction(e,t,s){if("object"!=typeof e||null===e)return void s.push({path:t,message:"Action must be an object",suggestion:"Provide action with type and params",code:"INVALID_ACTION_TYPE"});const i=["gotoScene","spawn","despawn","setVar","incVar","randomInt","if","tween","playSprite","setCamera","shake","playSfx","playMusic","startTimer","stopTimer","emit","moveCamera"];e.type?i.includes(e.type)||s.push({path:`${t}.type`,message:`Invalid action type: ${e.type}`,suggestion:`Use one of: ${i.join(", ")}`,code:"INVALID_ACTION_TYPE_VALUE"}):s.push({path:`${t}.type`,message:"Action must have a type",suggestion:`Use one of: ${i.join(", ")}`,code:"MISSING_ACTION_TYPE"}),e.params&&"object"==typeof e.params||s.push({path:`${t}.params`,message:"Action must have params object",suggestion:"Provide params object with action-specific parameters",code:"MISSING_ACTION_PARAMS"})}validateTrigger(e,t,s){if("object"!=typeof e||null===e)return void s.push({path:t,message:"Trigger must be an object",suggestion:"Provide trigger with event and actions",code:"INVALID_TRIGGER_TYPE"});const i=["on.start","on.tick","on.key","on.pointer","on.timer","on.raycastHit"];e.event?i.includes(e.event)||s.push({path:`${t}.event`,message:`Invalid trigger event: ${e.event}`,suggestion:`Use one of: ${i.join(", ")}`,code:"INVALID_TRIGGER_EVENT"}):s.push({path:`${t}.event`,message:"Trigger must have an event",suggestion:`Use one of: ${i.join(", ")}`,code:"MISSING_TRIGGER_EVENT"}),e.actions&&Array.isArray(e.actions)?e.actions.forEach((e,i)=>{this.validateAction(e,`${t}.actions[${i}]`,s)}):s.push({path:`${t}.actions`,message:"Trigger must have actions array",suggestion:"Provide array of actions to execute when trigger fires",code:"MISSING_TRIGGER_ACTIONS"})}validateAssets(e,t){"object"==typeof e&&null!==e?["sprites","audio","fonts"].forEach(s=>{s in e?Array.isArray(e[s])||t.push({path:`assets.${s}`,message:`Assets ${s} must be an array`,suggestion:`Provide ${s} as an array of asset objects`,code:"INVALID_ASSET_TYPE_FORMAT"}):t.push({path:`assets.${s}`,message:`Missing required asset type: ${s}`,suggestion:`Add "${s}" array to your assets`,code:"MISSING_ASSET_TYPE"})}):t.push({path:"assets",message:"Assets must be an object",suggestion:"Provide assets with sprites, audio, and fonts arrays",code:"INVALID_ASSETS_TYPE"})}validateVariables(e,t){if("object"==typeof e&&null!==e)for(const[s,i]of Object.entries(e)){["number","string","boolean"].includes(typeof i)||t.push({path:`variables.${s}`,message:`Variable ${s} has invalid type: ${typeof i}`,suggestion:"Variables must be numbers, strings, or booleans",code:"INVALID_VARIABLE_TYPE"})}else t.push({path:"variables",message:"Variables must be an object",suggestion:"Provide variables as an object with string keys and number/string/boolean values",code:"INVALID_VARIABLES_TYPE"})}validateSemantics(e,t){e.scenes.forEach((e,s)=>{e.root.children&&0!==e.root.children.length||t.push({path:`scenes[${s}]`,message:`Scene "${e.id}" has no child nodes`,suggestion:"Consider adding some content to make the scene interactive"})});const s=e.assets.sprites.length;s>100&&t.push({path:"assets.sprites",message:`Large number of sprites (${s})`,suggestion:"Consider optimizing sprite usage for better performance"})}isValidColor(e){return"string"==typeof e&&/^#([0-9A-Fa-f]{3}|[0-9A-Fa-f]{6}|[0-9A-Fa-f]{8})$/.test(e)}}function r(e){return(new a).validate(e)}class n{constructor(){this.sprites=new Map,this.fonts=new Map,this.loadingPromises=new Map,this.defaultSprite=null,this.defaultFont="Arial, sans-serif",this.createDefaultAssets()}async loadAssets(e,t={}){const{onProgress:s,timeout:i=1e4,retryCount:a=2}=t,r=[...e.sprites.map(e=>({...e,type:"sprite"})),...e.fonts.map(e=>({...e,type:"font"}))],n={total:r.length,loaded:0,failed:0,progress:0};s&&s(n);const o=r.map(async e=>{try{n.currentAsset=e.id,"sprite"===e.type?await this.loadSpriteAsset(e,i,a):"font"===e.type&&await this.loadFontAsset(e,i,a),n.loaded++}catch(e){n.failed++}n.progress=(n.loaded+n.failed)/n.total,s&&s(n)});await Promise.allSettled(o)}async loadSpriteAsset(e,t=1e4,s=2){const i=this.sprites.get(e.id);if(i)return i;const a=this.loadingPromises.get(`sprite:${e.id}`);if(a)return a;const r=this.loadSpriteWithRetry(e,t,s);this.loadingPromises.set(`sprite:${e.id}`,r);try{const t=await r;return this.sprites.set(e.id,t),t}finally{this.loadingPromises.delete(`sprite:${e.id}`)}}async loadFontAsset(e,t=1e4,s=2){const i=this.fonts.get(e.id);if(i)return i;const a=this.loadingPromises.get(`font:${e.id}`);if(a)return a;const r=this.loadFontWithRetry(e,t,s);this.loadingPromises.set(`font:${e.id}`,r);try{const t=await r;return this.fonts.set(e.id,t),t}finally{this.loadingPromises.delete(`font:${e.id}`)}}getSprite(e){return this.sprites.get(e)||null}getFont(e){return this.fonts.get(e)||null}getSpriteWithFallback(e){const t=this.sprites.get(e);return t?t.image:this.defaultSprite||this.createEmptyImage()}getFontWithFallback(e){const t=this.fonts.get(e);return t&&t.loaded?t.family:this.defaultFont}clearCache(){this.sprites.clear(),this.fonts.clear(),this.loadingPromises.clear()}getMemoryUsage(){let e=0;for(const t of this.sprites.values())e+=t.width*t.height*4;const t=1024*this.fonts.size;return{sprites:e,fonts:t,total:e+t}}isAssetLoaded(e,t){if("sprite"===t)return this.sprites.has(e);if("font"===t){const t=this.fonts.get(e);return!!t&&t.loaded}return!1}async loadSpriteWithRetry(e,t,s){let i=null;for(let a=0;a<=s;a++)try{return await this.loadSpriteImage(e,t)}catch(e){i=e,a<s&&await new Promise(e=>setTimeout(e,1e3*Math.pow(2,a)))}throw i}async loadFontWithRetry(e,t,s){let i=null;for(let a=0;a<=s;a++)try{return await this.loadFontFace(e,t)}catch(e){i=e,a<s&&await new Promise(e=>setTimeout(e,1e3*Math.pow(2,a)))}throw i}async loadSpriteImage(e,t){return new Promise((s,i)=>{const a=new Image;let r=null;const n=()=>{r&&clearTimeout(r),a.onload=null,a.onerror=null};a.onload=()=>{n(),s({id:e.id,image:a,width:e.width,height:e.height,frames:e.frames||1})},a.onerror=()=>{n(),i(new Error(`Failed to load sprite: ${e.url}`))},r=setTimeout(()=>{n(),i(new Error(`Sprite load timeout: ${e.url}`))},t),a.crossOrigin="anonymous",a.src=e.url})}async loadFontFace(e,t){return"undefined"==typeof FontFace?{id:e.id,family:e.family,loaded:!0}:new Promise((s,i)=>{const a=new FontFace(e.family,`url(${e.url})`);let r=null;const n=()=>{r&&clearTimeout(r)};r=setTimeout(()=>{n(),i(new Error(`Font load timeout: ${e.url}`))},t),a.load().then(()=>{n(),document.fonts.add(a),s({id:e.id,family:e.family,loaded:!0})}).catch(t=>{n(),i(new Error(`Failed to load font: ${e.url} - ${t.message}`))})})}createDefaultAssets(){try{const e=document.createElement("canvas");e.width=1,e.height=1;const t=e.getContext("2d");t&&(t.fillStyle="rgba(255, 0, 255, 0.5)",t.fillRect(0,0,1,1)),this.defaultSprite=new Image,this.defaultSprite.src=e.toDataURL()}catch(e){this.defaultSprite=new Image,this.defaultSprite.width=1,this.defaultSprite.height=1}}createEmptyImage(){const e=new Image;return e.width=1,e.height=1,e}}class o{constructor(e,t){this.assetManager=e||new n,this.audioManager=t||new i}async loadFromJSON(e,t={}){const{onProgress:s,validateOnly:i=!1,skipAssets:a=!1}=t;let n;s&&s({stage:"parsing",progress:0,message:"Parsing cartridge JSON..."});try{n=JSON.parse(e)}catch(e){throw new Error(`Invalid JSON: ${e instanceof Error?e.message:"Unknown parsing error"}`)}s&&s({stage:"parsing",progress:1,message:"JSON parsed successfully"}),s&&s({stage:"validating",progress:0,message:"Validating cartridge format..."});const o=r(n);if(s&&s({stage:"validating",progress:1,message:o.valid?"Validation successful":`Validation failed with ${o.errors.length} errors`}),!o.valid)throw new Error(`Cartridge validation failed:\n${o.errors.map(e=>`- ${e.path}: ${e.message}`).join("\n")}`);return i||!a&&n.assets&&(s&&s({stage:"loading-assets",progress:0,message:"Loading assets..."}),await this.loadCartridgeAssets(n,{onProgress:e=>{s&&s({stage:"loading-assets",progress:e.progress,message:`Loading assets... (${e.loaded}/${e.total})`,assetProgress:e})},timeout:t.assetTimeout,retryCount:t.assetRetryCount})),{cartridge:n,validation:o,assetManager:this.assetManager,audioManager:this.audioManager}}async loadFromURL(e,t={}){const{onProgress:s}=t;s&&s({stage:"parsing",progress:0,message:`Fetching cartridge from ${e}...`});try{const i=await fetch(e);if(!i.ok)throw new Error(`HTTP ${i.status}: ${i.statusText}`);const a=await i.text();return s&&s({stage:"parsing",progress:.5,message:"Cartridge downloaded, parsing..."}),await this.loadFromJSON(a,t)}catch(e){throw new Error(`Failed to load cartridge from URL: ${e instanceof Error?e.message:"Unknown error"}`)}}async loadFromFile(e,t={}){const{onProgress:s}=t;return s&&s({stage:"parsing",progress:0,message:`Reading file ${e.name}...`}),new Promise((i,a)=>{const r=new FileReader;r.onload=async e=>{try{const a=e.target?.result;s&&s({stage:"parsing",progress:.5,message:"File read, parsing..."});const r=await this.loadFromJSON(a,t);i(r)}catch(e){a(e)}},r.onerror=()=>{a(new Error(`Failed to read file: ${r.error?.message||"Unknown error"}`))},r.readAsText(e)})}async validateCartridge(e){let t;if("string"==typeof e)try{t=JSON.parse(e)}catch(e){return{valid:!1,errors:[{path:"",message:`Invalid JSON: ${e instanceof Error?e.message:"Unknown parsing error"}`,code:"JSON_PARSE_ERROR"}],warnings:[]}}else t=e;return r(t)}getAssetManager(){return this.assetManager}getAudioManager(){return this.audioManager}clearCache(){this.assetManager.clearCache(),this.audioManager.cleanup()}getMemoryUsage(){const e=this.assetManager.getMemoryUsage();return{assets:e,audio:0,total:e.total+0}}async loadCartridgeAssets(e,t){const s=[];(e.assets.sprites.length>0||e.assets.fonts.length>0)&&s.push(this.assetManager.loadAssets({sprites:e.assets.sprites,audio:[],fonts:e.assets.fonts},t).catch(e=>{})),e.assets.audio.length>0&&s.push(this.audioManager.loadAssets(e.assets.audio).catch(e=>{})),await Promise.allSettled(s)}}class c{constructor(e={}){this.canvas=null,this.inputManager=null,this.ariaLiveRegion=null,this.focusIndicator=null,this.originalTheme=null,this.highContrastTheme=null,this.options={enableKeyboardNavigation:!0,enableScreenReader:!0,enableHighContrast:!1,textScaling:1,enableFocusIndicators:!0,announceStateChanges:!0,...e},this.state={currentFocus:null,focusableElements:[],isHighContrast:this.options.enableHighContrast,textScaling:this.options.textScaling,screenReaderEnabled:this.options.enableScreenReader},this.setupAccessibilityFeatures()}initialize(e,t){this.canvas=e,this.inputManager=t,this.setupCanvasAccessibility(),this.setupKeyboardNavigation(),this.setupScreenReaderSupport(),this.setupFocusManagement()}update(e){this.options.enableKeyboardNavigation&&(this.updateFocusableElements(e),this.handleKeyboardNavigation(),this.updateFocusIndicators())}setTheme(e){this.originalTheme=e,this.highContrastTheme=this.createHighContrastTheme(e),this.state.isHighContrast&&this.applyHighContrastTheme()}toggleHighContrast(){return this.state.isHighContrast=!this.state.isHighContrast,this.state.isHighContrast?(this.announceToScreenReader("High contrast mode enabled"),this.applyHighContrastTheme()):(this.announceToScreenReader("High contrast mode disabled"),this.originalTheme||this.createDefaultTheme())}setTextScaling(e){this.state.textScaling=Math.max(.5,Math.min(3,e)),this.announceToScreenReader(`Text scaling set to ${Math.round(100*this.state.textScaling)}%`)}getTextScaling(){return this.state.textScaling}focusNode(e){const t=this.state.focusableElements.find(t=>t.node.id===e);return!!t&&(this.setFocus(t),!0)}getCurrentFocus(){return this.state.currentFocus?.node||null}announceToScreenReader(e,t="polite"){this.state.screenReaderEnabled&&this.ariaLiveRegion&&(this.ariaLiveRegion.setAttribute("aria-live",t),this.ariaLiveRegion.textContent=e,setTimeout(()=>{this.ariaLiveRegion&&(this.ariaLiveRegion.textContent="")},1e3))}getAccessibilityState(){return{...this.state}}cleanup(){this.ariaLiveRegion&&(this.ariaLiveRegion.remove(),this.ariaLiveRegion=null),this.focusIndicator&&(this.focusIndicator.remove(),this.focusIndicator=null),this.state.focusableElements=[],this.state.currentFocus=null}setupAccessibilityFeatures(){window.matchMedia("(prefers-reduced-motion: reduce)").matches;window.matchMedia("(prefers-contrast: high)").matches&&(this.options.enableHighContrast=!0,this.state.isHighContrast=!0),window.matchMedia("(prefers-contrast: high)").addEventListener("change",e=>{e.matches&&!this.state.isHighContrast&&(this.state.isHighContrast=!0,this.applyHighContrastTheme())})}setupCanvasAccessibility(){if(!this.canvas)return;this.canvas.setAttribute("role","application"),this.canvas.setAttribute("aria-label","Game Canvas"),this.canvas.setAttribute("tabindex","0");const e=document.createElement("div");e.id="canvas-description",e.style.position="absolute",e.style.left="-10000px",e.textContent="Interactive game canvas. Use arrow keys to navigate, Enter to interact, and Tab to cycle through interactive elements.",document.body.appendChild(e),this.canvas.setAttribute("aria-describedby","canvas-description")}setupKeyboardNavigation(){this.inputManager&&this.options.enableKeyboardNavigation&&(this.inputManager.mapKey("tab","focus_next"),this.inputManager.mapKey("shift+tab","focus_previous"),this.inputManager.mapKey("enter","activate"),this.inputManager.mapKey("space","activate"),this.inputManager.mapKey("escape","cancel"),this.inputManager.mapKey("home","focus_first"),this.inputManager.mapKey("end","focus_last"),this.inputManager.mapKey("up","navigate_up"),this.inputManager.mapKey("down","navigate_down"),this.inputManager.mapKey("left","navigate_left"),this.inputManager.mapKey("right","navigate_right"))}setupScreenReaderSupport(){this.options.enableScreenReader&&(this.ariaLiveRegion=document.createElement("div"),this.ariaLiveRegion.setAttribute("aria-live","polite"),this.ariaLiveRegion.setAttribute("aria-atomic","true"),this.ariaLiveRegion.style.position="absolute",this.ariaLiveRegion.style.left="-10000px",this.ariaLiveRegion.style.width="1px",this.ariaLiveRegion.style.height="1px",this.ariaLiveRegion.style.overflow="hidden",document.body.appendChild(this.ariaLiveRegion))}setupFocusManagement(){this.options.enableFocusIndicators&&(this.focusIndicator=document.createElement("div"),this.focusIndicator.style.position="absolute",this.focusIndicator.style.border="2px solid #007acc",this.focusIndicator.style.borderRadius="4px",this.focusIndicator.style.pointerEvents="none",this.focusIndicator.style.zIndex="1000",this.focusIndicator.style.display="none",this.focusIndicator.setAttribute("aria-hidden","true"),document.body.appendChild(this.focusIndicator))}updateFocusableElements(e){this.state.focusableElements=[],this.collectFocusableElements(e,0),this.state.focusableElements.sort((e,t)=>{if(e.tabIndex!==t.tabIndex)return e.tabIndex-t.tabIndex;const s=e.node.getWorldTransform().position,i=t.node.getWorldTransform().position;return s.y-i.y||s.x-i.x})}collectFocusableElements(e,t){for(const s of e){if(this.isFocusable(s)){const e=this.createVirtualElement(s);this.state.focusableElements.push({node:s,element:e,tabIndex:t,ariaLabel:this.getAriaLabel(s),ariaRole:this.getAriaRole(s)}),t++}s.children&&this.collectFocusableElements(s.children,t)}}isFocusable(e){const t="function"==typeof e.isWorldVisible?e.isWorldVisible():e.visible;return e.visible&&t&&("Button"===e.type||"Text"===e.type&&e.interactive||!0===e.focusable)}createVirtualElement(e){const t=document.createElement("div");return t.setAttribute("role",this.getAriaRole(e)),t.setAttribute("aria-label",this.getAriaLabel(e)),t.style.position="absolute",t.style.left="-10000px",t}getAriaLabel(e){const t=e;return t.ariaLabel||t.text||t.label||`${e.type} ${e.id}`}getAriaRole(e){switch(e.type){case"Button":return"button";case"Text":return"text";default:return"generic"}}handleKeyboardNavigation(){this.inputManager&&(this.inputManager.isActionJustPressed("focus_next")?this.focusNext():this.inputManager.isActionJustPressed("focus_previous")?this.focusPrevious():this.inputManager.isActionJustPressed("focus_first")?this.focusFirst():this.inputManager.isActionJustPressed("focus_last")?this.focusLast():this.inputManager.isActionJustPressed("activate")?this.activateCurrentFocus():this.inputManager.isActionJustPressed("cancel")&&this.clearFocus(),this.inputManager.isActionJustPressed("navigate_up")?this.navigateDirection("up"):this.inputManager.isActionJustPressed("navigate_down")?this.navigateDirection("down"):this.inputManager.isActionJustPressed("navigate_left")?this.navigateDirection("left"):this.inputManager.isActionJustPressed("navigate_right")&&this.navigateDirection("right"))}focusNext(){if(0===this.state.focusableElements.length)return;const e=(this.getCurrentFocusIndex()+1)%this.state.focusableElements.length;this.setFocus(this.state.focusableElements[e])}focusPrevious(){if(0===this.state.focusableElements.length)return;const e=this.getCurrentFocusIndex(),t=0===e?this.state.focusableElements.length-1:e-1;this.setFocus(this.state.focusableElements[t])}focusFirst(){this.state.focusableElements.length>0&&this.setFocus(this.state.focusableElements[0])}focusLast(){this.state.focusableElements.length>0&&this.setFocus(this.state.focusableElements[this.state.focusableElements.length-1])}navigateDirection(e){if(!this.state.currentFocus)return void this.focusFirst();const t=this.state.currentFocus.node.getWorldTransform().position;let s=null,i=1/0;for(const a of this.state.focusableElements){if(a===this.state.currentFocus)continue;const r=a.node.getWorldTransform().position,n=r.x-t.x,o=r.y-t.y;let c=!1;switch(e){case"up":c=o<-10;break;case"down":c=o>10;break;case"left":c=n<-10;break;case"right":c=n>10}if(c){const e=Math.sqrt(n*n+o*o);e<i&&(i=e,s=a)}}s&&this.setFocus(s)}getCurrentFocusIndex(){return this.state.currentFocus?this.state.focusableElements.indexOf(this.state.currentFocus):-1}setFocus(e){this.state.currentFocus=e,this.options.announceStateChanges&&e&&this.announceToScreenReader(`Focused on ${e.ariaLabel}`),this.updateFocusIndicators()}clearFocus(){this.state.currentFocus=null,this.updateFocusIndicators()}activateCurrentFocus(){if(!this.state.currentFocus)return;"Button"===this.state.currentFocus.node.type&&this.announceToScreenReader(`Activated ${this.state.currentFocus.ariaLabel}`)}updateFocusIndicators(){if(!this.focusIndicator||!this.canvas)return;if(!this.state.currentFocus)return void(this.focusIndicator.style.display="none");const e=this.state.currentFocus.node,t="function"==typeof e.getWorldTransform?e.getWorldTransform():e.transform,s=this.canvas.getBoundingClientRect(),i=s.left+t.position.x,a=s.top+t.position.y;this.focusIndicator.style.left=i-25+"px",this.focusIndicator.style.top=a-25+"px",this.focusIndicator.style.width="50px",this.focusIndicator.style.height="50px",this.focusIndicator.style.display="block"}createHighContrastTheme(e){return{colors:{primary:"#ffffff",secondary:"#000000",background:"#000000",text:"#ffffff",accent:"#ffff00"},font:{...e.font,sizes:Object.fromEntries(Object.entries(e.font.sizes).map(([e,t])=>[e,Math.round(t*this.state.textScaling)]))},spacing:e.spacing,radii:e.radii}}applyHighContrastTheme(){return this.highContrastTheme=this.createHighContrastTheme(this.originalTheme||this.createDefaultTheme()),this.highContrastTheme}createDefaultTheme(){return{colors:{primary:"#007acc",secondary:"#666666",background:"#ffffff",text:"#000000",accent:"#ff6600"},font:{family:"Arial, sans-serif",sizes:{small:12,medium:16,large:24}},spacing:{small:4,medium:8,large:16},radii:{small:2,medium:4,large:8}}}}class h{constructor(e){this.state={running:!1,paused:!1,currentScene:null,tickCount:0,frameRate:0},this.cartridge=null,this.moduleRegistry=t.getInstance(),this.inputManager=new s,this.audioManager=new i,this.assetManager=new n,this.cartridgeLoader=new o(this.assetManager,this.audioManager),this.accessibilityManager=new c(e)}async loadCartridge(e,t){const s=await this.cartridgeLoader.loadFromJSON(JSON.stringify(e),t);for(const e of s.cartridge.scenes)this.validateNodeTree(e.root);this.cartridge=s.cartridge,s.cartridge.scenes.length>0&&(this.state.currentScene=s.cartridge.scenes[0].id)}async loadCartridgeFromJSON(e,t){const s=await this.cartridgeLoader.loadFromJSON(e,t);for(const e of s.cartridge.scenes)this.validateNodeTree(e.root);this.cartridge=s.cartridge,s.cartridge.scenes.length>0&&(this.state.currentScene=s.cartridge.scenes[0].id)}async loadCartridgeFromURL(e,t){const s=await this.cartridgeLoader.loadFromURL(e,t);for(const e of s.cartridge.scenes)this.validateNodeTree(e.root);this.cartridge=s.cartridge,s.cartridge.scenes.length>0&&(this.state.currentScene=s.cartridge.scenes[0].id)}async loadCartridgeFromFile(e,t){const s=await this.cartridgeLoader.loadFromFile(e,t);for(const e of s.cartridge.scenes)this.validateNodeTree(e.root);this.cartridge=s.cartridge,s.cartridge.scenes.length>0&&(this.state.currentScene=s.cartridge.scenes[0].id)}start(){if(!this.cartridge)throw new Error("No cartridge loaded");this.state.running=!0,this.state.paused=!1,this.state.tickCount=0}stop(){this.state.running=!1,this.state.paused=!1,this.state.tickCount=0,this.audioManager.stopMusic()}pause(){this.state.running&&(this.state.paused=!0)}resume(){this.state.running&&(this.state.paused=!1)}getState(){return{...this.state}}getInputManager(){return this.inputManager}getAudioManager(){return this.audioManager}getAssetManager(){return this.assetManager}getCartridgeLoader(){return this.cartridgeLoader}getAccessibilityManager(){return this.accessibilityManager}validateNodeTree(e){if(!e.type||!this.moduleRegistry.supportsNodeType(e.type))throw new Error(`Unsupported node type: ${e.type}`);if(e.triggers&&Array.isArray(e.triggers))for(const t of e.triggers)if(!this.moduleRegistry.supportsTriggerEvent(t.event))throw new Error(`Unsupported trigger event: ${t.event}`);if(e.children&&Array.isArray(e.children))for(const t of e.children)this.validateNodeTree(t)}}class d{constructor(e,t){this.parent=null,this.id=e,this.type=t,this.transform={position:{x:0,y:0},scale:{x:1,y:1},rotation:0,skew:{x:0,y:0},alpha:1},this.visible=!0,this.children=[],this.actions=[],this.triggers=[]}addChild(e){if(e===this)throw new Error("Cannot add node as child of itself");if(this.isDescendantOf(e))throw new Error("Cannot add ancestor as child (circular reference)");e.parent&&e.parent.removeChild(e),this.children.push(e),e.parent=this}removeChild(e){const t=this.children.indexOf(e);return-1!==t&&(this.children.splice(t,1),e.parent=null,!0)}removeFromParent(){return!!this.parent&&this.parent.removeChild(this)}isDescendantOf(e){let t=this.parent;for(;t;){if(t===e)return!0;t=t.parent}return!1}getRoot(){let e=this;for(;e.parent;)e=e.parent;return e}getDepth(){let e=0,t=this.parent;for(;t;)e++,t=t.parent;return e}getWorldTransform(){if(!this.parent)return{...this.transform};const e=this.parent.getWorldTransform();return{position:{x:e.position.x+this.transform.position.x*e.scale.x,y:e.position.y+this.transform.position.y*e.scale.y},scale:{x:e.scale.x*this.transform.scale.x,y:e.scale.y*this.transform.scale.y},rotation:e.rotation+this.transform.rotation,skew:{x:e.skew.x+this.transform.skew.x,y:e.skew.y+this.transform.skew.y},alpha:e.alpha*this.transform.alpha}}isWorldVisible(){if(!this.visible)return!1;let e=this.parent;for(;e;){if(!e.visible)return!1;e=e.parent}return!0}}class l{constructor(){this._seed=1}seed(e){this._seed=Math.abs(e)||1}random(){return this._seed=(1664525*this._seed+1013904223)%4294967296,this._seed/4294967296}randomInt(e,t){return Math.floor(this.random()*(t-e+1))+e}randomFloat(e,t){return this.random()*(t-e)+e}}class u{static screenToWorld(e,t,s,i){const{width:a,height:r,horizon:n}=i,o=(e-a/2)/(a/2),c=r*n;if(Math.abs(t-c)<.001)return{x:s.position.x,y:s.position.y};const h=t-c,d=s.height/(h/r*Math.tan(s.pitch)),l=d*o,u=d;return{x:s.position.x+l*Math.cos(s.rotation)-u*Math.sin(s.rotation),y:s.position.y+l*Math.sin(s.rotation)+u*Math.cos(s.rotation)}}static worldToScreen(e,t,s,i){const{width:a,height:r,horizon:n}=i,o=e-s.position.x,c=t-s.position.y,h=o*Math.cos(-s.rotation)-c*Math.sin(-s.rotation),d=o*Math.sin(-s.rotation)+c*Math.cos(-s.rotation);if(d<=.001)return{x:-1,y:-1};return{x:a/2+h/d*(a/2),y:r*n+s.height/(d*Math.tan(s.pitch))*r}}static getTextureCoordinates(e,t,s,i){const a=(e.x*s+i.x)%t.x,r=(e.y*s+i.y)%t.y;return{x:a<0?a+t.x:a,y:r<0?r+t.y:r}}static createDefaultCamera(){return{position:{x:0,y:0},rotation:0,height:100,pitch:Math.PI/6,fov:Math.PI/3}}}class p{constructor(){this.name="mode7",this.nodeTypes=["Mode7Plane"],this.textureCache=new Map,this.defaultCamera=u.createDefaultCamera()}render(e,t){const s=e,i=this.getMode7Data(s);if(!i)return;const a=this.getMode7Camera(t)||this.defaultCamera,r=this.getTexture(i.texture);if(!r)return void this.renderPlaceholder(t,i);const n={width:t.viewport.width,height:t.viewport.height,horizon:i.horizon};this.renderMode7Plane(t,i,a,r,n)}getMode7Data(e){const t=e;return t.texture?{texture:t.texture,horizon:t.horizon??.5,scale:t.scale??1,offset:t.offset??{x:0,y:0},textureWidth:t.textureWidth??256,textureHeight:t.textureHeight??256}:null}getMode7Camera(e){return e.mode7Camera||null}getTexture(e){return this.textureCache.has(e)?this.textureCache.get(e):null}renderPlaceholder(e,t){const{ctx:s,viewport:i}=e,a=i.height*t.horizon,r=s.createLinearGradient(0,a,0,i.height);r.addColorStop(0,"#87CEEB"),r.addColorStop(1,"#228B22"),s.fillStyle=r,s.fillRect(0,a,i.width,i.height-a),s.strokeStyle="#FFFFFF",s.lineWidth=2,s.beginPath(),s.moveTo(0,a),s.lineTo(i.width,a),s.stroke()}renderMode7Plane(e,t,s,i,a){const{ctx:r}=e,n=a.height*t.horizon,o=r.createImageData(a.width,a.height-n),c=o.data,h=document.createElement("canvas");h.width=i.width,h.height=i.height;const d=h.getContext("2d");d.drawImage(i,0,0);const l=d.getImageData(0,0,i.width,i.height);for(let e=0;e<a.height-n;e++){const i=n+e;this.renderScanline(c,e,i,a.width,t,s,a,l)}r.putImageData(o,0,n)}renderScanline(e,t,s,i,a,r,n,o){const c=t*i*4;for(let t=0;t<i;t++){const i=u.screenToWorld(t,s,r,n),h=u.getTextureCoordinates(i,{x:a.textureWidth,y:a.textureHeight},a.scale,a.offset),d=this.sampleTexture(o,h.x,h.y),l=c+4*t;e[l]=d.r,e[l+1]=d.g,e[l+2]=d.b,e[l+3]=255}}sampleTexture(e,t,s){const i=Math.floor(t)%e.width,a=4*(Math.floor(s)%e.height*e.width+i);return{r:e.data[a],g:e.data[a+1],b:e.data[a+2]}}}const g={name:"mode7",nodeTypes:["Mode7Plane"],actions:["setMode7Camera","moveMode7Camera"],triggers:[],dependencies:[],size:8};class m{constructor(e,t){this.emitter=e,this.maxParticles=t,this.particles=[],this.nextParticleId=0,this.emissionAccumulator=0}update(e){this.updateParticles(e),this.removeDeadParticles(),this.emitter.enabled&&this.particles.length<this.maxParticles&&this.spawnParticles(e)}getParticles(){return this.particles}startEmit(){this.emitter.enabled=!0}stopEmit(){this.emitter.enabled=!1}burstEmit(e){for(let t=0;t<e&&this.particles.length<this.maxParticles;t++)this.spawnParticle()}clear(){this.particles.length=0}updateEmitter(e){Object.assign(this.emitter,e)}updateParticles(e){for(const t of this.particles){t.age+=e,t.velocity.x+=t.acceleration.x*e,t.velocity.y+=t.acceleration.y*e,t.position.x+=t.velocity.x*e,t.position.y+=t.velocity.y*e,t.rotation+=t.rotationSpeed*e;const s=t.age/t.maxLifetime;void 0!==t.alphaEnd&&(t.alpha=this.lerp(t.alpha,t.alphaEnd,s)),t.colorEnd&&(t.color=this.lerpColor(t.color,t.colorEnd,s))}}removeDeadParticles(){this.particles=this.particles.filter(e=>e.age<e.maxLifetime)}spawnParticles(e){if(!(this.emitter.rate<=0))for(this.emissionAccumulator+=e*this.emitter.rate;this.emissionAccumulator>=1&&this.particles.length<this.maxParticles;)this.spawnParticle(),this.emissionAccumulator-=1}spawnParticle(){const e=this.emitter.lifetime+2*(Math.random()-.5)*this.emitter.lifetimeVariance,t={x:this.emitter.velocity.x+2*(Math.random()-.5)*this.emitter.velocityVariance.x,y:this.emitter.velocity.y+2*(Math.random()-.5)*this.emitter.velocityVariance.y},s=this.emitter.scale+2*(Math.random()-.5)*this.emitter.scaleVariance,i={id:this.nextParticleId++,position:{...this.emitter.position},velocity:t,acceleration:{...this.emitter.acceleration},scale:Math.max(.1,s),rotation:this.emitter.rotation,rotationSpeed:this.emitter.rotationSpeed,color:this.emitter.color,colorEnd:this.emitter.colorEnd,alpha:this.emitter.alpha,alphaEnd:this.emitter.alphaEnd,lifetime:Math.max(.1,e),maxLifetime:Math.max(.1,e),age:0};this.particles.push(i)}lerp(e,t,s){return e+(t-e)*Math.min(1,Math.max(0,s))}lerpColor(e,t,s){return s>.5?t:e}}class f{constructor(){this.name="particles",this.nodeTypes=["Particles2D"],this.particleSystems=new Map,this.textureCache=new Map}render(e,t){const s=e;let i=this.particleSystems.get(e.id);i||(i=new m(s.emitter,s.maxParticles),this.particleSystems.set(e.id,i));i.update(1/60),this.renderParticles(i.getParticles(),s,t)}handleAction(e,t,s){let i=this.particleSystems.get(e);if(!i&&("startEmit"===t||"burstEmit"===t)){i=new m({position:{x:0,y:0},rate:10,lifetime:1,lifetimeVariance:0,velocity:{x:0,y:0},velocityVariance:{x:0,y:0},acceleration:{x:0,y:0},scale:1,scaleVariance:0,rotation:0,rotationSpeed:0,color:"#ffffff",alpha:1,enabled:!0},100),this.particleSystems.set(e,i)}if(i)switch(t){case"startEmit":i.startEmit();break;case"stopEmit":i.stopEmit();break;case"burstEmit":i.burstEmit(s.count||10)}}cleanup(e){this.particleSystems.delete(e)}renderParticles(e,t,s){const{ctx:i}=s,a=i.globalCompositeOperation;if(t.blendMode)switch(t.blendMode){case"additive":i.globalCompositeOperation="lighter";break;case"multiply":i.globalCompositeOperation="multiply";break;default:i.globalCompositeOperation="source-over"}for(const i of e)this.renderParticle(i,t,s);i.globalCompositeOperation=a}renderParticle(e,t,s){const{ctx:i}=s;if(i.save(),i.translate(e.position.x,e.position.y),i.rotate(e.rotation),i.scale(e.scale,e.scale),i.globalAlpha=e.alpha,t.texture){const s=this.getTexture(t.texture);s?i.drawImage(s,-s.width/2,-s.height/2):this.renderColoredParticle(e,i)}else this.renderColoredParticle(e,i);i.restore()}renderColoredParticle(e,t){t.fillStyle=e.color,t.beginPath(),t.arc(0,0,4,0,2*Math.PI),t.fill()}getTexture(e){return this.textureCache.has(e)?this.textureCache.get(e):null}}const y={name:"particles",nodeTypes:["Particles2D"],actions:["startEmit","stopEmit","burstEmit"],triggers:[],dependencies:[],size:6};e.ActionSystem=class{constructor(){this.tweens=new Map,this.timers=new Map,this.nextTweenId=0,this.nextTimerId=0}async executeAction(e,t){if(!e.conditions||this.evaluateConditions(e.conditions,t))switch(e.type){case"gotoScene":this.executeGotoScene(e,t);break;case"spawn":this.executeSpawn(e,t);break;case"despawn":this.executeDespawn(e,t);break;case"setVar":this.executeSetVar(e,t);break;case"incVar":this.executeIncVar(e,t);break;case"randomInt":this.executeRandomInt(e,t);break;case"if":this.executeIf(e,t);break;case"tween":this.executeTween(e,t);break;case"startTimer":this.executeStartTimer(e,t);break;case"stopTimer":this.executeStopTimer(e,t);break;case"playSfx":this.executePlaySfx(e,t);break;case"playMusic":this.executePlayMusic(e,t);break;case"stopMusic":this.executeStopMusic(e,t)}}update(e){this.updateTweens(e),this.updateTimers(e)}evaluateConditions(e,t){return e.every(e=>this.evaluateCondition(e,t))}evaluateCondition(e,t){const s=t.variables.get(e.variable);switch(e.type){case"equals":return s===e.value;case"greater":return"number"==typeof s&&s>(e.value||0);case"less":return"number"==typeof s&&s<(e.value||0);case"exists":return void 0!==s;default:return!1}}executeGotoScene(e,t){const s=e.params.scene;"string"==typeof s&&t.variables.set("__nextScene",s)}executeSpawn(e,t){const s=e.params.node,i=e.params.parent||t.node.id;if(s&&"object"==typeof s){const e=this.createNodeFromData(s),a=t.sceneNodes.get(i);a&&e&&(a.addChild(e),t.sceneNodes.set(e.id,e))}}executeDespawn(e,t){const s=e.params.node||t.node.id,i=t.sceneNodes.get(s);i&&(i.removeFromParent(),t.sceneNodes.delete(s))}executeSetVar(e,t){const s=e.params.variable,i=e.params.value;"string"==typeof s&&t.variables.set(s,i)}executeIncVar(e,t){const s=e.params.variable,i=e.params.amount||1;if("string"==typeof s){const e=t.variables.get(s)||0;"number"==typeof e&&t.variables.set(s,e+i)}}executeRandomInt(e,t){const s=e.params.min||0,i=e.params.max||100,a=e.params.variable;if("string"==typeof a){const e=t.gameLoop.getRNG().randomInt(s,i);t.variables.set(a,e)}}executeIf(e,t){const s=e.params.condition,i=e.params.then||[],a=e.params.else||[];if(s&&this.evaluateCondition(s,t))for(const e of i)this.executeAction(e,t);else for(const e of a)this.executeAction(e,t)}executeTween(e,t){const s=e.params.target||t.node,i=e.params.property,a=e.params.to,r=e.params.duration||1e3,n=this.getEasingFunction(e.params.easing||"linear");if(!s||!i||void 0===a)return;const o=this.getPropertyValue(s,i);if("number"!=typeof o||"number"!=typeof a)return;const c="tween_"+this.nextTweenId++,h={object:s,property:i,startValue:o,endValue:a,duration:r,elapsed:0,easing:n};this.tweens.set(c,h)}executeStartTimer(e,t){const s=e.params.duration||1e3,i=e.params.actions||[],a=e.params.id||"timer_"+this.nextTimerId++,r={id:a,duration:s,elapsed:0,actions:i,context:t};this.timers.set(a,r)}executeStopTimer(e,t){const s=e.params.id;"string"==typeof s&&this.timers.delete(s)}executePlaySfx(e,t){const s=e.params.id,i=e.params.volume;"string"==typeof s&&t.audioManager.playSfx(s,i)}executePlayMusic(e,t){const s=e.params.id,i=e.params.loop,a=e.params.volume;"string"==typeof s&&t.audioManager.playMusic(s,i,a)}executeStopMusic(e,t){t.audioManager.stopMusic()}createNodeFromData(e){return null}getPropertyValue(e,t){const s=t.split(".");let i=e;for(const e of s){if(!i||"object"!=typeof i||!(e in i))return;i=i[e]}return i}setPropertyValue(e,t,s){const i=t.split(".");let a=e;for(let e=0;e<i.length-1;e++){const t=i[e];if(!a||"object"!=typeof a||!(t in a))return;a=a[t]}const r=i[i.length-1];a&&"object"==typeof a&&(a[r]=s)}getEasingFunction(e){switch(e){case"linear":default:return e=>e;case"easeIn":return e=>e*e;case"easeOut":return e=>1-(1-e)*(1-e);case"easeInOut":return e=>e<.5?2*e*e:1-2*(1-e)*(1-e)}}updateTweens(e){const t=[];for(const[s,i]of this.tweens){i.elapsed+=e;const a=Math.min(i.elapsed/i.duration,1),r=i.easing(a),n=i.startValue+(i.endValue-i.startValue)*r;this.setPropertyValue(i.object,i.property,n),a>=1&&t.push(s)}for(const e of t)this.tweens.delete(e)}updateTimers(e){const t=[];for(const[s,i]of this.timers)if(i.elapsed+=e,i.elapsed>=i.duration){for(const e of i.actions)this.executeAction(e,i.context);t.push(s)}for(const e of t)this.timers.delete(e)}},e.AssetManager=n,e.AudioManager=i,e.CartridgeLoader=o,e.GameLoop=class{constructor(e){this.tickRate=60,this.tickInterval=1e3/60,this._running=!1,this._paused=!1,this._callbacks={},this._lastTime=0,this._accumulator=0,this._tickCount=0,this._frameCount=0,this._frameTimeHistory=[],this._lastFpsUpdate=0,this._currentFps=0,this._droppedFrames=0,this._rng=new l,this._rafHandle=null,this._gameLoopStep=()=>{if(!this._running)return;const e=performance.now(),t=e-this._lastTime;if(this._lastTime=e,this._frameCount++,this._frameTimeHistory.push(t),this._frameTimeHistory.length>60&&this._frameTimeHistory.shift(),e-this._lastFpsUpdate>=1e3&&(this._currentFps=Math.round(1e3/(this._frameTimeHistory.reduce((e,t)=>e+t,0)/this._frameTimeHistory.length)),this._lastFpsUpdate=e),!this._paused){this._accumulator+=t;const e=5*this.tickInterval;if(this._accumulator>e){const t=this._accumulator-e,s=Math.floor(t/this.tickInterval);this._droppedFrames+=s,this._accumulator=e}for(;this._accumulator>=this.tickInterval;)this._tick(),this._accumulator-=this.tickInterval,this._tickCount++}const s=this._paused?0:this._accumulator/this.tickInterval;this._render(s,t),this._rafHandle=requestAnimationFrame(this._gameLoopStep)},this._callbacks=e||{},this._rng.seed(Date.now())}start(){this._running||(this._running=!0,this._paused=!1,this._lastTime=performance.now(),this._startTime=this._lastTime,this._accumulator=0,this._tickCount=0,this._frameCount=0,this._droppedFrames=0,this._frameTimeHistory=[],this._lastFpsUpdate=this._lastTime,this._gameLoopStep())}stop(){this._running=!1,this._paused=!1,null!==this._rafHandle&&(cancelAnimationFrame(this._rafHandle),this._rafHandle=null)}pause(){this._paused=!0}resume(){this._running&&(this._paused=!1,this._lastTime=performance.now(),this._accumulator=0)}setCallbacks(e){this._callbacks={...this._callbacks,...e}}getMetrics(){const e=this._frameTimeHistory.length>0?this._frameTimeHistory.reduce((e,t)=>e+t,0)/this._frameTimeHistory.length:0;return{fps:this._currentFps,averageFrameTime:e,tickRate:this.tickRate,droppedFrames:this._droppedFrames,totalTicks:this._tickCount,totalFrames:this._frameCount}}getRNG(){return this._rng}seedRNG(e){this._rng.seed(e)}get tickCount(){return this._tickCount}get frameCount(){return this._frameCount}get isRunning(){return this._running}get isPaused(){return this._paused}_tick(){this._callbacks.onTick&&this._callbacks.onTick(this._tickCount,this.tickInterval)}_render(e,t){this._callbacks.onRender&&this._callbacks.onRender(e,t)}},e.InputIntegration=class{constructor(e,t){this.previousKeyStates=new Map,this.previousPointerStates=new Map,this.inputManager=e,this.triggerSystem=t}update(e){this.checkKeyStateChanges(e),this.checkPointerStateChanges(e)}setupDefaultMappings(){this.inputManager.mapKey("up","nav-up"),this.inputManager.mapKey("down","nav-down"),this.inputManager.mapKey("left","nav-left"),this.inputManager.mapKey("right","nav-right"),this.inputManager.mapKey("space","primary-action"),this.inputManager.mapKey("enter","confirm"),this.inputManager.mapKey("escape","cancel"),this.inputManager.mapKey("tab","next"),this.inputManager.mapKey("w","move-up"),this.inputManager.mapKey("a","move-left"),this.inputManager.mapKey("s","move-down"),this.inputManager.mapKey("d","move-right"),this.inputManager.mapPointer(0,"primary-click"),this.inputManager.mapPointer(2,"secondary-click")}checkKeyStateChanges(e){const t=["space","enter","escape","tab","up","down","left","right","w","a","s","d","shift","ctrl","alt"];for(const s of t){const t=this.previousKeyStates.get(s)||!1,i=this.inputManager.isActionPressed(this.getActionForKey(s));if(i!==t){const t={type:"key",key:s,pressed:i};this.triggerSystem.handleInput(t,e),this.previousKeyStates.set(s,i)}}}checkPointerStateChanges(e){const t=[0,1,2];for(const s of t){const t=this.previousPointerStates.get(s)||!1,i=this.inputManager.isActionPressed(this.getActionForPointer(s));if(i!==t){const t={type:"pointer",button:s,position:this.inputManager.getPointerPosition(),pressed:i};this.triggerSystem.handleInput(t,e),this.previousPointerStates.set(s,i)}}}getActionForKey(e){return{up:"nav-up",down:"nav-down",left:"nav-left",right:"nav-right",space:"primary-action",enter:"confirm",escape:"cancel",tab:"next",w:"move-up",a:"move-left",s:"move-down",d:"move-right"}[e]||e}getActionForPointer(e){return{0:"primary-click",1:"middle-click",2:"secondary-click"}[e]||`button-${e}`}isActionPressed(e){return this.inputManager.isActionPressed(e)}isActionJustPressed(e){return this.inputManager.isActionJustPressed(e)}isActionJustReleased(e){return this.inputManager.isActionJustReleased(e)}getPointerPosition(){return this.inputManager.getPointerPosition()}},e.InputManagerImpl=s,e.LGFValidator=a,e.LLMRTEngine=h,e.Mode7Math=u,e.Mode7ModuleDefinition=g,e.Mode7RenderModule=p,e.ModuleRegistry=t,e.NodeFactory=class{static createGroup(e){return new d(e,"Group")}static createSprite(e,t){const s=new d(e,"Sprite");return t&&(s.spriteId=t),s}static createText(e,t){const s=new d(e,"Text");return void 0!==t&&(s.text=t),s}static createButton(e,t){const s=new d(e,"Button");return void 0!==t&&(s.text=t),s}static createCamera2D(e){const t=new d(e,"Camera2D");return t.zoom=1,t.target={x:0,y:0},t}},e.NodeImpl=d,e.ParticleSystem=m,e.ParticlesModuleDefinition=y,e.ParticlesRenderModule=f,e.Renderer=class{constructor(e,t){this.modules=new Map,this.nodeTypeToModule=new Map,this.qualitySettings={renderScale:1,particleDensity:1,shadowQuality:"medium",textureFiltering:!0,postProcessing:!0,audioQuality:"high",maxActiveAudioSources:8},this.renderStats={drawCalls:0,triangles:0,sprites:0,renderTime:0,culledNodes:0,batchedSprites:0},this.spriteBatch=[],this.enableFrustumCulling=!0,this.enableSpriteBatching=!0,this.canvas=e;const s=e.getContext("2d",{alpha:!1,desynchronized:!0,willReadFrequently:!1});if(!s)throw new Error("Failed to get 2D rendering context");this.ctx=s,this.theme=t,this.camera={position:{x:0,y:0},zoom:1,rotation:0,target:{x:0,y:0}},this.viewport={width:e.width,height:e.height,scale:1,offset:{x:0,y:0}},this.setupOffscreenCanvas(),this.optimizeCanvasSettings(),this.detectPlatformOptimizations(),this.registerCoreRenderers(),this.loadRegisteredModules(),this.setupResponsiveCanvas()}render(e,t){const s=performance.now();this.renderStats={drawCalls:0,triangles:0,sprites:0,renderTime:0,culledNodes:0,batchedSprites:0};const i=this.qualitySettings.renderScale<1&&this.offscreenCtx?this.offscreenCtx:this.ctx,a=this.qualitySettings.renderScale<1&&this.offscreenCanvas?this.offscreenCanvas:this.canvas;i.clearRect(0,0,a.width,a.height),this.renderStats.drawCalls++,i.fillStyle=this.theme.colors.background,i.fillRect(0,0,a.width,a.height),this.renderStats.drawCalls++,this.setupCameraTransform(t,i);const r={canvas:a,ctx:i,camera:this.camera,theme:this.theme,interpolation:t,viewport:this.viewport},n=this.cullNodes(e);this.renderOptimized(n,r),i!==this.ctx&&this.offscreenCanvas&&(this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.ctx.drawImage(this.offscreenCanvas,0,0,this.offscreenCanvas.width,this.offscreenCanvas.height,0,0,this.canvas.width,this.canvas.height),this.renderStats.drawCalls++),i.restore(),this.renderStats.renderTime=performance.now()-s,this.performanceMonitor&&this.performanceMonitor.updateMetrics(this.renderStats.renderTime,this.getMemoryUsage(),this.renderStats.sprites,this.renderStats.drawCalls)}registerModule(e){this.modules.set(e.name,e);for(const t of e.nodeTypes)this.nodeTypeToModule.set(t,e);t.getInstance().registerRenderModule(e)}setTheme(e){this.theme=e,this.accessibilityManager&&this.accessibilityManager.setTheme(e)}setCamera(e){Object.assign(this.camera,e)}getViewport(){return{...this.viewport}}screenToWorld(e){return{x:(e.x-this.viewport.offset.x)/this.camera.zoom+this.camera.position.x,y:(e.y-this.viewport.offset.y)/this.camera.zoom+this.camera.position.y}}worldToScreen(e){return{x:(e.x-this.camera.position.x)*this.camera.zoom+this.viewport.offset.x,y:(e.y-this.camera.position.y)*this.camera.zoom+this.viewport.offset.y}}setupCameraTransform(){this.ctx.save(),this.ctx.translate(this.viewport.offset.x,this.viewport.offset.y),this.ctx.scale(this.viewport.scale,this.viewport.scale),this.ctx.translate(this.canvas.width/2,this.canvas.height/2),this.ctx.scale(this.camera.zoom,this.camera.zoom),this.ctx.rotate(this.camera.rotation),this.ctx.translate(-this.camera.position.x,-this.camera.position.y)}renderNode(e,t){const s=this.getInterpolatedWorldTransform(e);if(s.alpha<=0)return;t.ctx.save(),this.applyTransform(t.ctx,s);const i=this.nodeTypeToModule.get(e.type);i&&i.render(e,t);for(const s of e.children)s.visible&&this.renderNode(s,t);t.ctx.restore()}getInterpolatedWorldTransform(e){return e.getWorldTransform()}applyTransform(e,t){e.translate(t.position.x,t.position.y),e.rotate(t.rotation),e.scale(t.scale.x,t.scale.y),0===t.skew.x&&0===t.skew.y||e.transform(1,Math.tan(t.skew.y),Math.tan(t.skew.x),1,0,0),e.globalAlpha*=t.alpha}registerCoreRenderers(){const e={name:"core",nodeTypes:["Group","Sprite","Text","Button","Camera2D"],render:(e,t)=>{this.renderCoreNode(e,t)}};this.registerModule(e)}renderCoreNode(e,t){switch(e.type){case"Group":case"Camera2D":break;case"Sprite":this.renderSprite(e,t);break;case"Text":this.renderText(e,t);break;case"Button":this.renderButton(e,t)}}renderSprite(e,t){if(!e.spriteId)return t.ctx.fillStyle=t.theme.colors.primary,void t.ctx.fillRect(-25,-25,50,50);t.ctx.fillStyle=t.theme.colors.primary,t.ctx.fillRect(-25,-25,50,50)}renderText(e,t){const s=e.text||"Text";let i=e.fontSize||t.theme.font.sizes.medium||16;this.accessibilityManager&&(i=Math.round(i*this.accessibilityManager.getTextScaling())),t.ctx.font=`${i}px ${t.theme.font.family}`,t.ctx.fillStyle=t.theme.colors.text,t.ctx.textAlign="center",t.ctx.textBaseline="middle",t.ctx.fillText(s,0,0)}renderButton(e,t){const s=e.text||"Button";let i=e.fontSize||t.theme.font.sizes.medium||16;const a=t.theme.spacing.medium||8;this.accessibilityManager&&(i=Math.round(i*this.accessibilityManager.getTextScaling()));const r=this.accessibilityManager?.getCurrentFocus()?.id===e.id;t.ctx.font=`${i}px ${t.theme.font.family}`;const n=t.ctx.measureText(s).width,o=i,c=Math.max(n+2*a,44),h=Math.max(o+2*a,44);t.ctx.fillStyle=r?t.theme.colors.accent:t.theme.colors.secondary;const d=t.theme.radii.small||4;this.drawRoundedRect(t.ctx,-c/2,-h/2,c,h,d),r&&(t.ctx.strokeStyle=t.theme.colors.primary,t.ctx.lineWidth=2,t.ctx.setLineDash([4,2]),this.strokeRoundedRect(t.ctx,-c/2-2,-h/2-2,c+4,h+4,d+2),t.ctx.setLineDash([])),t.ctx.fillStyle=t.theme.colors.text,t.ctx.textAlign="center",t.ctx.textBaseline="middle",t.ctx.fillText(s,0,0)}drawRoundedRect(e,t,s,i,a,r){e.beginPath(),e.moveTo(t+r,s),e.lineTo(t+i-r,s),e.quadraticCurveTo(t+i,s,t+i,s+r),e.lineTo(t+i,s+a-r),e.quadraticCurveTo(t+i,s+a,t+i-r,s+a),e.lineTo(t+r,s+a),e.quadraticCurveTo(t,s+a,t,s+a-r),e.lineTo(t,s+r),e.quadraticCurveTo(t,s,t+r,s),e.closePath(),e.fill()}strokeRoundedRect(e,t,s,i,a,r){e.beginPath(),e.moveTo(t+r,s),e.lineTo(t+i-r,s),e.quadraticCurveTo(t+i,s,t+i,s+r),e.lineTo(t+i,s+a-r),e.quadraticCurveTo(t+i,s+a,t+i-r,s+a),e.lineTo(t+r,s+a),e.quadraticCurveTo(t,s+a,t,s+a-r),e.lineTo(t,s+r),e.quadraticCurveTo(t,s,t+r,s),e.closePath(),e.stroke()}loadRegisteredModules(){const e=t.getInstance(),s=e.getRegisteredModules();for(const t of s){const s=e.getRenderModule(t.name);if(s){this.modules.set(s.name,s);for(const e of s.nodeTypes)this.nodeTypeToModule.set(e,s)}}}setupResponsiveCanvas(){const e=()=>{const e=this.canvas.parentElement;if(!e)return;const t=e.getBoundingClientRect(),s=window.devicePixelRatio||1;let i;i=this.canvas.width/this.canvas.height>t.width/t.height?t.width/this.canvas.width:t.height/this.canvas.height,this.viewport={width:this.canvas.width,height:this.canvas.height,scale:i*s,offset:{x:(t.width-this.canvas.width*i)/2,y:(t.height-this.canvas.height*i)/2}},this.canvas.style.width=this.canvas.width*i+"px",this.canvas.style.height=this.canvas.height*i+"px"};window.addEventListener("resize",e),e()}setupOffscreenCanvas(){try{this.offscreenCanvas=document.createElement("canvas"),this.offscreenCanvas.width=this.canvas.width,this.offscreenCanvas.height=this.canvas.height,this.offscreenCtx=this.offscreenCanvas.getContext("2d",{alpha:!1,desynchronized:!0,willReadFrequently:!1})}catch(e){}}optimizeCanvasSettings(){this.ctx.imageSmoothingEnabled=this.qualitySettings.textureFiltering,this.offscreenCtx&&(this.offscreenCtx.imageSmoothingEnabled=this.qualitySettings.textureFiltering),this.ctx.globalCompositeOperation="source-over"}detectPlatformOptimizations(){const e=/Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent),t=this.detectLowEndDevice();(e||t)&&(this.qualitySettings.renderScale=.8,this.qualitySettings.particleDensity=.7,this.qualitySettings.textureFiltering=!1,this.qualitySettings.postProcessing=!1,this.maxBatchSize=50,this.enableFrustumCulling=!0,this.enableSpriteBatching=!0)}detectLowEndDevice(){const e=navigator.deviceMemory,t=navigator.hardwareConcurrency;return!!(e&&e<4)||!!(t&&t<4)}cullNodes(e){if(!this.enableFrustumCulling)return e.filter(e=>e.visible&&e.isWorldVisible());const t=[],s=this.calculateFrustum();for(const i of e)i.visible&&i.isWorldVisible()&&(this.isNodeInFrustum(i,s)?t.push(i):this.renderStats.culledNodes++);return t}calculateFrustum(){const e=this.canvas.width/(2*this.camera.zoom),t=this.canvas.height/(2*this.camera.zoom);return{left:this.camera.position.x-e,right:this.camera.position.x+e,top:this.camera.position.y-t,bottom:this.camera.position.y+t}}isNodeInFrustum(e,t){const s=e.getWorldTransform(),i=this.getNodeBounds(e,s);return!(i.right<t.left||i.left>t.right||i.bottom<t.top||i.top>t.bottom)}getNodeBounds(e,t){return{left:t.position.x-25,right:t.position.x+25,top:t.position.y-25,bottom:t.position.y+25}}renderOptimized(e,t){if(this.enableSpriteBatching)this.renderWithBatching(e,t);else for(const s of e)this.renderNode(s,t)}renderWithBatching(e,t){this.spriteBatch=[];const s=[];for(const t of e)"Sprite"===t.type&&this.canBatchSprite(t)?this.spriteBatch.push(t):s.push(t);this.spriteBatch.length>0&&this.renderSpriteBatch(t);for(const e of s)this.renderNode(e,t)}canBatchSprite(e){const t=e.getWorldTransform();return 0===t.rotation&&0===t.skew.x&&0===t.skew.y&&1===t.alpha}renderSpriteBatch(e){if(0===this.spriteBatch.length)return;e.ctx.save(),this.spriteBatch.sort((e,t)=>{const s=e,i=t;return(s.texture||s.color||"").localeCompare(i.texture||i.color||"")});let t="";for(const s of this.spriteBatch){const i=s,a=s.getWorldTransform(),r=i.texture||i.color||e.theme.colors.primary;r!==t&&(e.ctx.fillStyle=r,t=r);const n=50;e.ctx.fillRect(a.position.x-n/2,a.position.y-n/2,n*a.scale.x,n*a.scale.y),this.renderStats.sprites++,this.renderStats.batchedSprites++}e.ctx.restore(),this.renderStats.drawCalls++}getMemoryUsage(){return this.memoryManager?this.memoryManager.getCurrentMemoryUsage()/1024/1024:"memory"in performance?performance.memory.usedJSHeapSize/1024/1024:0}setPerformanceMonitor(e){this.performanceMonitor=e,e.setCallbacks({onQualityChange:e=>{this.updateQualitySettings(e)}})}setMemoryManager(e){this.memoryManager=e}setAccessibilityManager(e){this.accessibilityManager=e}updateQualitySettings(e){if(this.qualitySettings=e,1!==e.renderScale&&this.offscreenCanvas){const t=Math.floor(this.canvas.width*e.renderScale),s=Math.floor(this.canvas.height*e.renderScale);this.offscreenCanvas.width=t,this.offscreenCanvas.height=s}this.ctx.imageSmoothingEnabled=e.textureFiltering,this.offscreenCtx&&(this.offscreenCtx.imageSmoothingEnabled=e.textureFiltering),this.maxBatchSize=Math.floor(100*e.particleDensity)}getRenderStats(){return{...this.renderStats}}optimizeForMobile(){this.qualitySettings.renderScale=.75,this.qualitySettings.textureFiltering=!1,this.qualitySettings.postProcessing=!1,this.maxBatchSize=50,this.enableFrustumCulling=!0,this.enableSpriteBatching=!0,this.updateQualitySettings(this.qualitySettings)}getPerformanceRecommendations(){const e=[],t=this.renderStats;return t.drawCalls>100&&e.push("High draw call count - consider sprite batching"),t.renderTime>16&&e.push("Render time exceeds 16ms - reduce visual complexity"),t.sprites>200&&e.push("Too many sprites - consider culling off-screen objects"),t.culledNodes/(t.sprites+t.culledNodes)<.1&&e.push("Low culling efficiency - check frustum culling implementation"),e}resize(e,t){this.canvas.width=e,this.canvas.height=t,this.offscreenCanvas&&(this.offscreenCanvas.width=Math.floor(e*this.qualitySettings.renderScale),this.offscreenCanvas.height=Math.floor(t*this.qualitySettings.renderScale)),this.optimizeCanvasSettings()}},e.SceneTree=class{constructor(e){this.nodeMap=new Map,this.root=e,this.buildNodeMap(e)}getRoot(){return this.root}addNode(e,t){const s=t?this.findNode(t):this.root;if(!s)throw new Error(`Parent node with id '${t}' not found`);if(this.nodeMap.has(e.id))throw new Error(`Node with id '${e.id}' already exists in scene`);s.addChild(e),this.addToNodeMap(e)}removeNode(e){const t=this.findNode(e);if(!t)return!1;const s=t.removeFromParent();return s&&this.removeFromNodeMap(t),s}findNode(e){return this.nodeMap.get(e)||null}findNodesByType(e){const t=[];return this.traverseNodes(this.root,s=>{s.type===e&&t.push(s)}),t}getAllNodes(){return Array.from(this.nodeMap.values())}traverseNodes(e,t){t(e);for(const s of e.children)this.traverseNodes(s,t)}getVisibleNodes(){const e=[];return this.collectVisibleNodes(this.root,e),e}collectVisibleNodes(e,t){if(e.visible){t.push(e);for(const s of e.children)this.collectVisibleNodes(s,t)}}buildNodeMap(e){this.nodeMap.set(e.id,e);for(const t of e.children)this.buildNodeMap(t)}addToNodeMap(e){this.nodeMap.set(e.id,e);for(const t of e.children)this.addToNodeMap(t)}removeFromNodeMap(e){this.nodeMap.delete(e.id);for(const t of e.children)this.removeFromNodeMap(t)}},e.TriggerSystem=class{constructor(e){this.activeNodes=new Set,this.keyStates=new Map,this.pointerStates=new Map,this.timers=new Map,this.actionSystem=e}registerNode(e,t){if(this.activeNodes.add(e),t){const s={...t,node:e};this.processTriggers(e,"on.start",s)}}unregisterNode(e){this.activeNodes.delete(e)}processTick(e){for(const t of this.activeNodes){const s={...e,node:t};this.processTriggers(t,"on.tick",s)}}handleInput(e,t){"key"===e.type?this.handleKeyEvent(e,t):"pointer"===e.type&&this.handlePointerEvent(e,t)}processTimers(e,t){for(const[s,i]of this.timers){const a=i-t;if(a<=0){for(const t of this.activeNodes){const i={...e,node:t,eventData:{timerId:s}};this.processTriggers(t,"on.timer",i)}this.timers.delete(s)}else this.timers.set(s,a)}}startTimer(e,t){this.timers.set(e,t)}stopTimer(e){this.timers.delete(e)}processTriggers(e,t,s){if(e.triggers&&s)for(const i of e.triggers)if(i.event===t)for(const e of i.actions)this.actionSystem.executeAction(e,s)}handleKeyEvent(e,t){if(!e.key)return;const s=this.keyStates.get(e.key)||!1,i=e.pressed||!1;if(this.keyStates.set(e.key,i),i&&!s)for(const s of this.activeNodes){const i={...t,node:s,eventData:{key:e.key}};if(s.triggers)for(const t of s.triggers)if("on.key"===t.event){const s=this.getTriggerKey(t);if(!s||s===e.key)for(const e of t.actions)this.actionSystem.executeAction(e,i)}}}handlePointerEvent(e,t){const s=e.button||0,i=this.pointerStates.get(s)||!1,a=e.pressed||!1;if(this.pointerStates.set(s,a),a&&!i)for(const i of this.activeNodes)if(this.isPointerOverNode(i,e.position)){const a={...t,node:i,eventData:{button:s,position:e.position}};this.processTriggers(i,"on.pointer",a)}}getTriggerKey(){return null}isPointerOverNode(e,t){if(!t||!e.visible)return!1;const s=e.transform.position;return Math.sqrt(Math.pow(t.x-s.x,2)+Math.pow(t.y-s.y,2))<50}isKeyPressed(e){return this.keyStates.get(e)||!1}isPointerPressed(e=0){return this.pointerStates.get(e)||!1}clearInputStates(){this.keyStates.clear(),this.pointerStates.clear()}},e.createCartridgeLoader=function(e,t){return new o(e,t)},e.createEngine=function(){return new h},e.loadCartridge=async function(e,t){return(new o).loadFromJSON(e,t)},e.registerMode7Module=function(){const e=t.getInstance();e.registerModule(g);const s=new p;e.registerRenderModule(s),e.registerActionHandler("setMode7Camera",e=>{}),e.registerActionHandler("moveMode7Camera",e=>{})},e.registerModule=function(e){t.getInstance().registerModule(e)},e.registerParticlesModule=function(){const e=t.getInstance();e.registerModule(y);const s=new f;e.registerRenderModule(s),e.registerActionHandler("startEmit",(e,t)=>{t.nodeId&&s.handleAction(t.nodeId,"startEmit",e)}),e.registerActionHandler("stopEmit",(e,t)=>{t.nodeId&&s.handleAction(t.nodeId,"stopEmit",e)}),e.registerActionHandler("burstEmit",(e,t)=>{t.nodeId&&s.handleAction(t.nodeId,"burstEmit",e)})},e.registerRenderModule=function(e){t.getInstance().registerRenderModule(e)},e.validateCartridge=r});
//# sourceMappingURL=llmrt.min.js.map
